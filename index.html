<!doctype html>
<meta charset="utf-8">
<script src="https://distill.pub/template.v1.js"></script>

<style>
  .figure .caption {
    font-size: 16px;
    line-height: 18px;
    margin: 0;
  }
  .figure .caption-centered {
    font-size: 16px;
    line-height: 18px;
    margin: 0;
    text-align: center;
  }
  .figure .figure-content {
    width: 100%;
  }
  .columns {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
  }
  .columns .column-2 {
    width: 50%;
    padding: 10px;
  }
  .columns .column-4 {
    width: 25%;
    padding: 10px;
  }
  .mujoco-red {
    color: #804040;
  }
  .mujoco-blue {
    color: #4080a4;
  }
</style>

<script type="text/front-matter">
  title: "Adversarial Agents in MARL"
  description: "Description of the post"
  authors:
  - Jarek Liesen
  affiliations:
  - BCCN Berlin: https://www.bccn-berlin.de
</script>

<dt-article>
  <h1>Adversarial Agents in multi-agent reinforcement learning</h1>
  <!-- <h2>A description of the article</h2> -->
  <dt-byline></dt-byline>
  <!-- Introduction -->
  <p>
    Adversarial attacks are a well-known phenomenon in machine learning that poses a threat to the security of many practical applications.
    To attack a neural network, one adds a small pertubation to its input, which leads to a misclassification.
    They have been studied extensively in the context of computer vision, and more recently in reinforcement learning (RL).
  </p>
  <div class="l-page side">
    <div class="columns">
      <div class="column-2 figure">
        <img class="figure-content" src="static/hopper.gif">
        <p class="caption">Hopper agent trained with PPO under normal circumstances<br><b>Reward</b>: 3104</p>
      </div>
      <div class="column-2 figure">
        <img class="figure-content" src="static/hopper_pa.gif">
        <p class="caption">The same Hopper agent under adversarial attack from <dt-cite key="sun2021who"></dt-cite><br><b>Reward</b>: 171</p>
      </div>
    </div>
  </div>
  <p>
    In an RL setting, perturbed observations can fool an agent with a neural network policy into taking actions that lead to poor performance
    <dt-cite key="huang2017adversarial"></dt-cite><dt-cite key="chen2019adversarial"></dt-cite>.
    For example, look at the hopper on the right, where the observations have been unnoticeably perturbed, leading to a detrimental drop in the cumulative reward.
    There is a multitude of methods to attack RL agents, including classical methods such as FGSM <dt-cite key="goodfellow2014explaining"></dt-cite>,
    and methods that exploit RL specific properties <dt-cite key="kos2017delving"></dt-cite><dt-cite key="sun2021who"></dt-cite>.
    The majority of these methods assume that the attacker is able to freely modify the agent's observations, which might not be possible in many cases.
    However, an interesting opportunity arises in multi-agent RL (MARL) settings, where agents observe each other:
  </p>
  <p><i>An attacker might take the form of an agent in MARL, whose actions directly influence the victim's observations.</i></p>
  <p>
    This is the key idea in Gleave et al's paper "Adversarial Policies: Attacking Deep Reinforcement Learning" <dt-cite key="gleave2020adversarial"></dt-cite>,
    who train adversarial agents that attack victims in several two-player games.
    In this post, we will take a closer look at those adversarial agents, analyze how they work, and discuss ways to defend against them.
  </p>
  <h2>Setting things up</h2>
  <p>
    We will train adversarial agents on four different mujoco environments, each of which implements a two-player, zero-sum game.
    Originally, these environments have been introduced in Bansal et al's paper "Emergent	Complexity via Multi-Agent Competition" <dt-cite key="bansal2018emergent"></dt-cite>,
    who trained several agents competing in each environment.
    In the visualizations in the rest of the article, we will see the behavior of the first pretrained agent.
    For our experiments, we will focus on the following four:
  </p>
  <div class="l-page-outset columns">
    <!-- All videos are from the zoo agents with tag 1 -->
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/you-shall-not-pass-zoo-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>You Shall Not Pass</b> (humans)<br>
        Asymmetric, MLP policy<br>
        1 pretrained agent
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/kick-and-defend-zoo-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Kick and Defend</b> (humans)<br>
        Asymmetric, LSTM policy<br>
        3 pretrained agents
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-humans-zoo-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (humans)<br>
        Symmetric, LSTM polic<br>
        3 pretrained agents
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-ants-zoo-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (ants)<br>
        Symmetric, LSTM policy<br>
        4 pretrained agents
      </p>
    </div>
  </div>
  <p>
    The score you see above has the form <i>#wins - #losses - #draws</i>, from the perspective of one of the agents, which we will call the attacker.
    Right now, the attacker acts according to its pretrained policy, but later we will train an adversarial policy to act in its place.
    <ul>
      <li>In <b>You Shall Not Pass</b> the attacker is the red agent, who wins if the blue agent falls to the ground before it reaches the red line, and loses otherwise.</li>
      <li>
        In <b>Kick and Defend</b> the attacker is the blue agent, who wins if the red agent fails to score, but the ball remains within the vicinity of the goal.
        The blue agent loses if a goal is scored, otherwise it is a draw.
      </li>
      <li>In <b>Sumo</b> the attacker is the blue agent. If the agents had contact, and one of the falls to the ground or outside the arena, that agent loses. A draw is declared on timeout or premature stumbling.</li>
    </ul>
  </p>

  <h2>Training an adversarial agent</h2>
  <p>
    While training the attacker, we keep the victim's policy fixed.
    This is not an unrealistic assumption, as in practice neural networks are often frozen before deployment, in order to avoid performance degradation due to retraining.
    Additionally, this simplifies our training setup, because our victim can be "absorbed" into the environment, by incorporating the victim's policy into the transition function.
    In pseudocode, this could look something like this:
  </p>
  <dt-code block language="python">
    class AttackerEnv(gym.Env):
        """ An environment that wraps a multi-agent environment and inserts 
            the victim's actions at index 1. """

        ...
        
        def step(self, action):
            # Get the action the victim would take in the current state
            victim_action = self.victim_policy(self._get_obs())

            # Give the attacker's action as well as the victim's action
            # to the wrapped multi-agent environment
            obs, reward, done, info = self.env.step([action, victim_action])

            # Return the observation and reward of the attacker
            return obs[0], reward[0], done, info
  </dt-code>
  <p>
    Note that the environment now takes in only an action from the attacker, and returns only the attacker's observation and reward, meaning...
  </p>
  <p><i>The attacker can be trained in a single-agent environment.</i></p>
  <p>
    Our goal for the attacker is simply to win as much as possible.
    Therefore, we don't use the reward function of the environment, but reward the attacker when it wins, and penalize it otherwise.
    We do this by giving a sparse reward at the end of the episode, either 1000 or -1000 depending on the game result.
  </p>
  <p>
    With the environment and reward in place, we can use any standard RL algorithm to train our attacker.
    In our case, we used the PPO implementation of stable baselines 3 <dt-cite key="stable-baselines3"></dt-cite> 
    with the hyperparameters provided in <dt-cite key="gleave2020adversarial"></dt-cite>.
  </p>

  <h2>Training results</h2>
  <div class="l-page-outset columns">
    <!-- All videos are from the zoo agents with tag 1 -->
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/you-shall-not-pass-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>You Shall Not Pass</b> (humans) <br>
        MLP policy, attacker in <span class="mujoco-red"><b>● Red</b></span>
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/kick-and-defend-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Kick and Defend</b> (humans)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-humans-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (humans)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
    <div class="column-4 figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-ants-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (ants)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
  </div>
  <p>
    The videos above show the adversaries at work.
    As you might notice, the success of our attack depends on the environment.
  </p>
  <div class="l-body side">
    <div class="figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/you-shall-not-pass-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>You Shall Not Pass</b> (humans) <br>
        MLP policy, attacker in <span class="mujoco-red"><b>● Red</b></span>
      </p>
    </div>
  </div>
  <p>
    In <b>You shall not pass</b>, the attacker is able to win almost every time (X% of the games).
    It does this not by obstructing the victim, or by any other interpretable means, but by falling to the ground and moving seemingly at random.
    This shows that the attacker produces adversarial observations, because the victim cannot cross the line despite any obstruction.
    This is not the case when placing the victim against a random policy, or one that does not exert forces on its joints at all (the zero policy).
  </p>

  <div class="l-body side">
    <div class="figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/kick-and-defend-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Kick and Defend</b> (humans)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
  </div>
  <p>
    In <b>Kick and Defend</b>, the attacker also achieves very good results against the victim (winning X% of the games).
    While the behavior of the attacker seems similar to the one in You Shall Not Pass, the effect it has on the victim is different.
    Instead of falling over, the victim seems to forget to kick the ball, resulting in a loss after the time limit is reached.
    Again, pairing up the victim against the random policy or the zero policy, it performs as expected.
  </p>

  <div class="l-body side">
    <div class="figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-humans-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (humans)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
  </div>
  <p>
    In <b>Sumo</b>, our attacks work fairly well, but the results differ a lot between the victims (X% of the games).
    Because the attacker cannot win when falling over, it learns to kneel in a stable position, while moving its arms.
    The constraint of staying upright limits the impact the attacker can have on the victim, which could explain the high variance in the attackers performance.
  </p>

  <div class="l-body side">
    <div class="figure">
      <video class="figure-content" autoplay loop controls>
        <source src="static/sumo-ants-adv-concat.mp4" type="video/mp4">
      </video>
      <p class="caption-centered">
        <b>Sumo</b> (ants)<br>
        LSTM policy, attacker in <span class="mujoco-blue"><b>● Blue</b></span>
      </p>
    </div>
  </div>
  <p>
    In <b>Sumo (ants)</b> our attack did not work against any of the victims.
    This is in line with the research on adversarial attacks, which shows that they work better in higher-dimensional input spaces <dt-cite key="goodfellow2014explaining"></dt-cite>.
    In comparison, the state of an ant agent is 15-dimensional, which that of a human is 24-dimensional.
    Still, we can observe that the attacker seems to stall the victim, while almost not moving itself.
    This is a vastly differnt behavior than that of the pretrained agents.
  </p>
  <p>
    All in all, we can gather two key takeaways:
  </p>
  <ul>
    <li>
      <i>It is easy to create adversarial agents by simply training to minimize the success of a victim.</i>
    </li>
    <li>
      <i>
        The success of the attack depends on how much control the attacker has over the victim's observation space
        (or in other words, the effective dimensionality of the manipulable subspace).
      </i>
    </li>
  </ul>
  <p>
    While the results we presented here are purely qualitative and visual, we provide a complete table of winrates in the <a href="#appendix">appendix</a>.
    Still, you might be unsatisfied, because while we have seen that the attacks work, we have not seen <i>how</i> they work.
  </p>

  <h2>
    Why do the adversarial attacks work?
  </h2>
  <p>
    In order to understand the mode of action of our attacks, we will analyze the activations in the victim's policy network.
    To do so, we will use two techniques, TSNE <dt-cite key="vandermaaten2008visualizing"></dt-cite> for a qualitative visualizations and a Gaussian mixture model for a statistical analysis.
  </p>

  <h2 id="appendix">Appendix</h2>

</dt-article>

<dt-appendix>
</dt-appendix>

<script type="text/bibliography">
  @article{gleave2020adversarial,
    title={Adversarial Policies: Attacking Deep Reinforcement Learning},
    author={Gleave, Adam and Dennis, Michael and Wild, Cody and Kant, Neel and Levine, Sergey and Russel, Stuart},
    journal={ICLR 2020},
    year={2020},
    url={https://openreview.net/forum?id=HJgEMpVFwB}
  }
  @article{chen2019adversarial,
    title={Adversarial attack and defense in reinforcement learning-from AI security view},
    author={Chen, Tong and Liu, Jiqiang and Xiang, Yingxiao and Niu, Wenjia and Tong, Endong and Han, Zhen},
    journal={Cybersecurity},
    year={2019},
    url={https://doi.org/10.1186/s42400-019-0027-x}
  }
  @article{goodfellow2014explaining,
    title={Explaining and harnessing adversarial examples},
    author={Goodfellow, Ian and Shlens, Jonathon and Szegedy, Christian},
    journal={CoRR},
    year={2014},
    url={https://arxiv.org/abs/1412.6572}
  }
  @article{kos2017delving,
    title={Delving into adversarial attacks on deep policies},
    author={Kos, Jernej and Song, Dawn},
    journal={ICLR 2017 workshop submission},
    year={2017},
    url={https://openreview.net/forum?id=BJcib5mFe}
  }
  @article{sun2021who,
    title={Who is the strongest enemy? Towards Optimal and Efficient Attacks in Deep RL},
    author={Sun, Yanchao and Zheng, Ruijie and Liang, Yongyuan and Huang, Furong},
    journal={ICLR 2022 Poster},
    year={2022},
    url={https://openreview.net/forum?id=JM2kFbJvvI}
  }
  @article{huang2017adversarial,
    title={Adversarial Attacks on Neural Network Policies},
    author={Huang, Sandy and Papernot, Nicolas and Goodfellow, Ian and Duan, Yan and Abbeel, Pieter},
    journal={ICLR 2017 workshop submission},
    year={2017},
    url={https://openreview.net/forum?id=ryvlRyBKl}
  }
  @article{bansal2018emergent,
    title={Emergent Complexity via Multi-Agent Competition},
    author={Bansal, Trapit and Pachocki, Jakub and Sutskever, Ilya and Mordatch, Igor},
    journal={ICLR 2018 conference submission},
    year={2018},
    url={https://openreview.net/forum?id=Sy0GnUxCb}
  }
  @article{schulman2017proximal,
    title={Proximal Policy Optimization Algorithms},
    author={Schulman, John and Wolski, Filip and Dhariwal, Prafulla and Radford, Alec and Klimov, Oleg},
    journal={ICLR 2017},
    year={2017},
    url={https://arxiv.org/abs/1707.06347}
  }
  @article{stable-baselines3,
    title   = {Stable-Baselines3: Reliable Reinforcement Learning Implementations},
    author  = {Antonin Raffin and Ashley Hill and Adam Gleave and Anssi Kanervisto and Maximilian Ernestus and Noah Dormann},
    journal = {Journal of Machine Learning Research},
    year    = {2021},
    url     = {http://jmlr.org/papers/v22/20-1364.html}
  }
  @article{vandermaaten2008visualizing,
    title   = {Visualizing Data using t-SNE},
    author  = {van der Maaten, Laurens and Hinton, Geoffrey},
    journal = {Journal of Machine Learning Research},
    year    = {2008},
    url     = {http://jmlr.org/papers/v9/vandermaaten08a.html}
  }
</script>
